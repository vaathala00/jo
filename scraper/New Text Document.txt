const axios = require("axios");
const fs = require("fs");

const STREAM_URL = "https://raw.githubusercontent.com/alex8875/m3u/refs/heads/main/jtv.m3u";
const OUTPUT_FILE = "stream.json";

async function fetchAndSaveJson() {
  try {
    const response = await axios.get(STREAM_URL, { responseType: "text" });
    const lines = response.data.split("\n");

    const result = {};

    let currentKid = null;
    let currentKey = null;
    let currentTvgId = null;

    for (const line of lines) {
      const trimmed = line.trim();

      // Extract tvg-id from #EXTINF
      if (trimmed.startsWith("#EXTINF:")) {
        const match = trimmed.match(/tvg-id="(\d+)"/);
        currentTvgId = match ? match[1] : null;
      }

      // Extract kid and key
      else if (trimmed.startsWith("#KODIPROP:inputstream.adaptive.license_key=")) {
        const [kid, key] = trimmed.split("=")[1].split(":");
        currentKid = kid;
        currentKey = key;
      }

      // Extract URL after license
      else if (currentKid && currentKey && currentTvgId && trimmed.startsWith("http")) {
        // Remove extra &xxx=... if present
        const cleanUrl = trimmed.split("&xxx=")[0];

        result[currentTvgId] = {
          kid: currentKid,
          key: currentKey,
          url: cleanUrl
        };

        // Reset for next entry
        currentKid = null;
        currentKey = null;
        currentTvgId = null;
      }
    }

    fs.writeFileSync(OUTPUT_FILE, JSON.stringify(result, null, 2), "utf-8");
    console.log("✅ stream.json saved successfully.");

  } catch (err) {
    console.error("❌ Failed to fetch M3U:", err.message);
    process.exit(1);
  }
}

fetchAndSaveJson();


